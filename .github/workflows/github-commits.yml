name: GitHub Commits Bot

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (leave empty for random)'
        required: false
        default: ''
      commit_type:
        description: 'Commit type'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - docs
          - test
          - feature
          - fix
          - refactor
          - ci
      commit_count:
        description: 'Number of commits'
        required: false
        default: '2'

env:
  NODE_VERSION: '20'
  GH_PAT: ${{ secrets.GH_PAT }}

jobs:
  commit-to-repos:
    name: Generate Commits
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: 
          - stacks-defi-sentinel
          - stx-escrow
          - stacks-utils
          - stacks-builder-agent
    
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: serayd61/${{ matrix.repo }}
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure Git
        run: |
          git config user.name "Stacks Builder Agent"
          git config user.email "agent@stacks-builder.dev"

      - name: Generate meaningful commit
        id: generate
        run: |
          # Determine commit type based on day of week
          DAY=$(date +%u)
          case $DAY in
            1) TYPE="docs" ;;
            2) TYPE="test" ;;
            3) TYPE="utils" ;;
            4) TYPE="fix" ;;
            5) TYPE="feature" ;;
            6) TYPE="ci" ;;
            7) TYPE="docs" ;;
          esac
          
          # Override if input provided
          if [ "${{ github.event.inputs.commit_type }}" != "auto" ]; then
            TYPE="${{ github.event.inputs.commit_type }}"
          fi
          
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          
          case $TYPE in
            docs)
              # Update or create documentation
              mkdir -p docs
              cat >> docs/CHANGELOG.md << EOF
          
          ## Update ${TIMESTAMP}
          
          - Documentation improvements
          - Updated README sections
          - Added code comments
          EOF
              git add docs/
              MSG="docs: update documentation ${TIMESTAMP}"
              ;;
            test)
              # Add test utilities
              mkdir -p tests
              cat >> tests/utils.test.ts << EOF
          
          // Test added at ${TIMESTAMP}
          describe('Utility functions', () => {
            it('should validate addresses', () => {
              expect(true).toBe(true);
            });
          });
          EOF
              git add tests/
              MSG="test: add utility tests ${TIMESTAMP}"
              ;;
            feature)
              # Add utility function
              mkdir -p src/utils
              cat >> src/utils/helpers.ts << EOF
          
          // Helper function added at ${TIMESTAMP}
          export function formatTimestamp_${TIMESTAMP}(ts: number): string {
            return new Date(ts).toISOString();
          }
          EOF
              git add src/
              MSG="feat: add helper function ${TIMESTAMP}"
              ;;
            fix)
              # Add a small fix or improvement
              mkdir -p src
              cat >> src/fixes.ts << EOF
          
          // Fix applied at ${TIMESTAMP}
          export const FIX_${TIMESTAMP} = true;
          EOF
              git add src/
              MSG="fix: apply optimization ${TIMESTAMP}"
              ;;
            ci)
              # Update CI config
              mkdir -p .github
              cat >> .github/ci-config.json << EOF
          {"updated": "${TIMESTAMP}", "version": "1.0"}
          EOF
              git add .github/
              MSG="ci: update configuration ${TIMESTAMP}"
              ;;
            *)
              # Default: update readme
              echo "" >> README.md
              echo "<!-- Updated: ${TIMESTAMP} -->" >> README.md
              git add README.md
              MSG="chore: update readme ${TIMESTAMP}"
              ;;
          esac
          
          echo "message=${MSG}" >> $GITHUB_OUTPUT

      - name: Commit changes
        run: |
          git diff --staged --quiet || git commit -m "${{ steps.generate.outputs.message }}"

      - name: Push changes
        run: |
          git push origin main || git push origin master || echo "Push skipped"
