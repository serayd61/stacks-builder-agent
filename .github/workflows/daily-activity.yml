name: Daily Builder Activity

on:
  schedule:
    # Run 3 times daily at 08:00, 14:00, and 20:00 UTC
    - cron: '0 8 * * *'
    - cron: '0 14 * * *'
    - cron: '0 20 * * *'
  workflow_dispatch:
    inputs:
      skip_github:
        description: 'Skip GitHub commits'
        required: false
        default: 'false'
      skip_onchain:
        description: 'Skip onchain transactions'
        required: false
        default: 'false'

env:
  NODE_VERSION: '20'
  STACKS_ADDRESS: ${{ secrets.STACKS_ADDRESS }}
  STACKS_PRIVATE_KEY: ${{ secrets.STACKS_PRIVATE_KEY }}
  GH_PAT: ${{ secrets.GH_PAT }}

jobs:
  github-activity:
    name: GitHub Commits
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_github != 'true' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config --global user.name "serayd61"
          git config --global user.email "serayd61@users.noreply.github.com"

      - name: Run GitHub Bot
        run: npm run github-bot
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Log completion
        run: |
          echo "✅ GitHub activity completed at $(date -u)"
          echo "Run ID: ${{ github.run_id }}"

  onchain-activity:
    name: Onchain Transactions
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_onchain != 'true' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Onchain Bot
        run: npm run onchain-bot
        env:
          STACKS_PRIVATE_KEY: ${{ secrets.STACKS_PRIVATE_KEY }}
          STACKS_ADDRESS: ${{ secrets.STACKS_ADDRESS }}

      - name: Log completion
        run: |
          echo "✅ Onchain activity completed at $(date -u)"
          echo "Run ID: ${{ github.run_id }}"

  progress-check:
    name: Check Progress
    runs-on: ubuntu-latest
    needs: [github-activity, onchain-activity]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Builder Progress
        run: npm run progress
        env:
          STACKS_ADDRESS: ${{ secrets.STACKS_ADDRESS }}

      - name: Create summary
        run: |
          echo "## Daily Activity Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Job**: ${{ needs.github-activity.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Onchain Job**: ${{ needs.onchain-activity.result }}" >> $GITHUB_STEP_SUMMARY
